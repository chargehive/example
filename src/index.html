<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="demo.css">

  <!-- START CHARGEHIVE SCRIPT -->
  <link rel="stylesheet" href="https://cdn.paymentauth.com/merchant/latest/v1/css/default.css">
  <script src="https://cdn.paymentauth.com/merchant/latest/v1/js/chargehive.min.js"></script>
  <script>
    ChargeHive.initialize(
      'PLACEMENT_TOKEN_HERE', // your placement token
      'PROJECT_ID_HERE' // your project id
    );
  </script>
  <!-- END CHARGEHIVE SCRIPT -->

  <script>


    let CURRENCY = 'USD';
    const CART = [];

    /* Event handlers */
    ChargeHive.addEventListener(ChargeHive.events.ON_TOKEN, function(event) {console.info("ON_TOKEN", event)});
    ChargeHive.addEventListener(ChargeHive.events.ON_SUCCESS, function (event) {
      document.querySelector('.container').innerText = 'Thanks for your purchase';
      console.info("ON_SUCCESS", event);
      console.log(event.detail.charge_id);
    });
    ChargeHive.addEventListener(ChargeHive.events.ON_DECLINED, function (event) {
      setNormal();
      alert('sorry, card declined. ' + event.detail.message);
      console.info("ON_DECLINE", event)
    });
    ChargeHive.addEventListener(ChargeHive.events.ON_PENDING, function (event) {
      return console.info(
        "ON_PENDING",
        event
      );
    });
    ChargeHive.addEventListener(ChargeHive.events.ON_VERIFY, function (event) {
      return console.info(
        "ON_VERIFY",
        event
      );
    });
    ChargeHive.addEventListener(ChargeHive.events.ON_READY, function (event) {
      console.debug("ON_READY", event);

      // your merchant reference
      ChargeHive.prepareCharge('YOUR_REFERENCE');

      /* customer info */
      ChargeHive.setCustomerInfo({firstName: 'Test', lastName: 'Customer'});
      ChargeHive.setBillingAddress(
        {
          address1: 'address1',
          city:     'city',
          state:    'state',
          country:  'GB',
          zip:      'zip',
        }
      );

      //Simplify Setup
      ChargeHive.setNameOnCard("John Smith");
      ChargeHive.setCardExpiry(12, 21);
      addToCart("Initial Product", 32.91);

    });
    ChargeHive.addEventListener(ChargeHive.events.ON_ERROR, function (event) {
      setNormal();

      if(!event.detail)
      {
        console.error('Error Without Detail:', event);

      }
      else
      {
        console.error('Error:', event.detail);
      }
      if(event.detail.type && event.detail.type === 'card')
      {
        document.querySelector('.ch-field-placeholder').style.border = '1px solid red';
      }
    });
    ChargeHive.addEventListener(ChargeHive.events.ON_ALL_VALID, function (event) {
      return console.debug(
        "ON_ALL_VALID",
        event
      );
    });
    ChargeHive.addEventListener(ChargeHive.events.ON_FIELD_CHANGE, function (event) {
      return console.debug(
        "ON_FIELD_CHANGE:",
        event
      );
    });
    ChargeHive.addEventListener(ChargeHive.events.ON_FOCUS, function (event) {
      return console.debug(
        "ON_FOCUS",
        event
      );
    });
    ChargeHive.addEventListener(ChargeHive.events.ON_BLUR, function (event) { return console.debug("ON_BLUR", event); });

    ChargeHive.setStyle(
      {
        all:     {
          default:  {color: 'black'},
          complete: {color: 'green'},
          empty:    {color: 'black'},
          invalid:  {color: 'red'}
        },
        cardNum: {
          invalid: {color: 'orange'}
        },
        cardExp: {
          invalid: {color: 'pink'}
        },
        cardCvv: {
          invalid: {color: 'purple'}
        }
      }
    );

    function addToCart(name, price) {
      CART.push({name: name, price: price});

      let cartEle = document.getElementById('cart');
      cartEle.innerHTML = '';

      for(let i in CART)
      {
        if(CART.hasOwnProperty(i))
        {
          let div = document.createElement('div');
          div.classList.add('col-75');
          div.innerHTML = CART[i].name + ' ¤' + CART[i].price;
          cartEle.appendChild(div);
        }
      }
      updateTransaction();
    }

    function updateTransaction() {
      let total = 0;
      for(let i in CART)
      {
        if(CART.hasOwnProperty(i))
        {
          total += Math.floor(CART[i].price * 100);
        }
      }
      document.getElementById('total').innerText = CURRENCY + ' ' + (total / 100);
      ChargeHive.updateCharge({amount: total, currency: CURRENCY});
    }

    function doIt() {
      ChargeHive.authorizeCharge();
      setProcessing();
    }

    function setProcessing() {
      document.querySelector('.ch-field-placeholder').style.border = '';
      document.querySelector('#doit').setAttribute('disabled', 'disabled');
      document.querySelector('#doit').innerText = 'Processing...';
    }

    function setNormal() {
      document.querySelector('#doit').removeAttribute('disabled');
      document.querySelector('#doit').innerText = 'Pay Now';
    }

    function changeColour() {
      let letters = '0123456789ABCDEF';
      let color = '#';
      for(let i = 0; i < 6; i++)
      {
        color += letters[Math.floor(Math.random() * 16)];
      }

      ChargeHive.setStyle(
        {
          cardNum: {
            default: {
              color:    color,
              ':hover': {color: 'orange'}
            },
          },
        }
      );
    }

    document.addEventListener('change', function (e) {
      if(e.target.id === 'currencySelector')
      {
        CURRENCY = e.target.value;
        updateTransaction();
      }
    });
  </script>
  <title>Checkout</title>
</head>
<body>
<p>Use this checkout page to test functionality of the checkout process using 3ds 2.0</p>
<div class="row">
  <div class="col-75">
    <div class="container">
      <div class="row">
        <div class="col-50">
          <h3>Cart</h3>
          <label>
            Currency:
            <select id="currencySelector">
              <option>USD</option>
              <option>EUR</option>
              <option>GBP</option>
            </select>
          </label>
          <div class="row" id="cart">
            <div class="col-75">
              Nothing Added
            </div>
          </div>
          <h3>Payment</h3>
          <div class="row">
            <div class="col-75">
              <div id="total"></div>
              <label class="ch-field-label">Credit card number</label>
              <div class="ch-field-placeholder">
                <span data-chargehive="cardName">Name on Card</span>
                <div class="ch-field-group ch-nowrap">
                  <span data-chargehive="cardBrand"></span>
                  <span data-chargehive="cardNum">Card number</span>
                </div>
                <span data-chargehive="cardExp">MM / YY</span>
                <span data-chargehive="cardCvv"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <span data-chargehive="verify" size="full"></span>
      <button id="doit" onclick="doIt()">Pay Now</button>
      <button onclick="changeColour()">Change Colour</button>
    </div>
  </div>
  <div class="col-25">
    <div class="container">
      <h4>Products <span class="price" style="color:black"><i class="fa fa-shopping-cart"></i></span></h4>
      <p><a href="#" onclick="addToCart('Blue Widget',9.99)">Blue Widget</a> <span class="price">¤9.99</span></p>
      <p><a href="#" onclick="addToCart('Red Widget',12.99)">Red Widget</a> <span class="price">¤12.99</span></p>
      <p><a href="#" onclick="addToCart('Blue Thingy',7.50)">Blue Thingy</a> <span class="price">¤7.50</span></p>
      <p><a href="#" onclick="addToCart('Red Thingy',5.70)">Red Thingy</a> <span class="price">¤5.70</span></p>
    </div>
  </div>
</div>
<div id="card-templates"></div>

</body>
</html>
